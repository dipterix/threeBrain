# [threeBrain - HTML, WebGL based 3D Viewer](https://dipterix.org/threeBrain/index.html)

[![](https://github.com/dipterix/threeBrain/blob/master/adhoc/demo.gif?raw=true)](https://youtu.be/dSxJqBiw3sk)

**Key Features**:

- Uses modern browsers, easy to **embed** and **share**
- Displays MRI, surfaces, and electrodes in the same canvas
- **Maps multiple subjects** on template brains using `AFNI/SUMA`
  (standard 141) or `MNI-305` locations
- **Electrode localization**
- Volume rendering and surface/electrode **animation**
- Integration with interactive `R-shiny` framework

[News](https://dipterix.org/threeBrain/news/index.html) \| [reference
page](https://dipterix.org/threeBrain/reference/index.html) \| [keyboard
shortcuts](https://dipterix.org/threeBrain/shortcuts.html)

#### System Requirement

- **Web Browsers**: the viewer uses `WegGL2` to render in browsers.
  Please check [this list](https://caniuse.com/webgl2) to see compatible
  browsers. As of 2023, **Chrome**, **Firefox**, **Safari**, and
  **Edge** (not IE) have full supports.

## A. Installation

1.  [`R`](https://cran.r-project.org/) and
    [`RStudio Desktop (Free Version)`](https://posit.co/download/rstudio-desktop/)
2.  Open `RStudio`, enter from its console:

``` r
install.packages("threeBrain", repos = "https://rave-ieeg.r-universe.dev")
```

If you want to install `dev` version from *Github*, then use:

``` r
install.packages("remotes")
remotes::install_github("dipterix/threeBrain")
```

3.  (Optional) Setups: after installation, in `RStudio` console, type
    the following command

``` r
threeBrain::brain_setup()
```

and follow the instructions.

## B. Basic Brain Viewer

Once finishing setting up of `threeBrain`, there will be a template
subject `N27` (Collin’s 27) created locally. The location is
platform-related. You can find it by running the following command:

``` r
library(threeBrain)

default_template_directory()
#> [1] "/Users/dipterix/Library/Application Support/
#> org.R-project.R/R/threeBrain/templates"
```

**N27** template folder resides inside of this directory.

Let’s view this subject using the `threeBrain` function.

1.  Import subject

``` r
library(threeBrain)

n27_path <- file.path(default_template_directory(), "N27")

x <- threeBrain( path = n27_path,
  subject_code = 'N27', surface_types = 'pial')
```

2.  Visualize

``` r
plot(x)       # alternatively, you can use x$plot()`
```

## C. Subject Setup

The sample subject (`N27`) is a sample generated by `FreeSurfer`
([download](https://surfer.nmr.mgh.harvard.edu/fswiki/DownloadAndInstall)).
If you have any subjects processed by `FreeSurfer`, use function
`threeBrain` to visualize.

## D. Add/Render Electrodes

If you have electrode file, you can import it before calling `plot`
function. Please make sure it’s in `csv` format.

``` r
x$set_electrodes(electrodes = "[PATH to ELECTRODE FILE]")
```

Here is an example of electrode csv file. Only the first five columns
(**case-sensitive**) are mandatory: `Electrode (integer)`, `Coord_x`,
`Coord_y`, `Coord_z`, and `Label (character)`. `Coord_*` is `tkRAS`
location from `FreeSurfer` coordinates.

    | Electrode| Coord_x| Coord_y| Coord_z|Label  | MNI305_x|  MNI305_y|  MNI305_z|SurfaceElectrode |SurfaceType | Radius| VertexNumber|Hemisphere |
    |---------:|-------:|-------:|-------:|:------|--------:|---------:|---------:|:----------------|:-----------|------:|------------:|:----------|
    |         1|    29.0|    -7.8|   -34.6|RMHCH1 | 30.46817| -17.98119| -23.40022|FALSE            |pial        |      2|           -1|left       |
    |         2|    33.8|    -8.0|   -34.2|RMHCH2 | 35.57109| -17.76624| -22.80131|FALSE            |pial        |      2|           -1|left       |
    |         3|    38.0|    -7.5|   -33.5|RMHCH3 | 39.97102| -16.81249| -22.17986|FALSE            |white       |      2|           -1|right      |
    |         4|    42.6|    -6.8|   -33.0|RMHCH4 | 44.79092| -15.73442| -21.82591|FALSE            |smoothwm    |      2|           -1|right      |
    |         5|    47.0|    -6.8|   -32.6|RMHCH5 | 49.45370| -15.35431| -21.31272|FALSE            |pial        |      2|           -1|right      |
    |         ...

To assign values to electrodes, run

``` r
x$set_electrode_values(electrodes = "[PATH to ELECTRODE VALUE FILE]")
```

The electrode value file is also a csv like:

    | Electrode| Subject| Project|    Time| ValueName| ValueName2|  ...|
    |---------:|-------:|-------:|-------:|:---------|----------:|-----|
    |         1|     N27|    Demo|       0|A         |   30.46817|  ...|
    |         2|     N27|    Demo|       0|B         |   35.57109|  ...|
    |         3|     N27|    Demo|       0|C         |   39.97102|  ...|
    |         4|     N27|    Demo|       0|D         |   44.79092|  ...|
    |         5|     N27|    Demo|       0|A         |   49.45370|  ...|
    |         ...

`Project` and `Time` are optional. However, if you are also using
[`rave`](https://github.com/beauchamplab/rave), please make sure
`Project` exists. If you want to show animation, `Time` is necessary and
must be numeric. `ValueName?` can be any characters containing letters
(`A-Z`, `a-z`), letters (`0-9`) and underscore (`_`).

## E. Merge Subjects and Template mapping

If you have your own subjects with `FreeSurfer` output, for example, I
have two subjects `YAB` and `YCQ`. To merge these two subjects and show
them on `N27` template,

``` r
library(threeBrain)

# yab = ... (see section B for import a single subject)
# ycq = ...
template_n27 = merge_brain(yab, ycq, template_subject = 'N27')

plot( template_n27 )
```

The viewer will be in `N27` template, and electrodes of these two
subjects can be mapped via `MNI305` (for surface and stereo EEG) or
`std.141` (for surface-only).

## F. Electrode Localization (`YAEL`)

[YAEL (“Your Advanced Electrode
Localizer)](https://doi.org/10.1523/ENEURO.0328-23.2023) has been
integrated into [RAVE (R Analysis and Visualization of
iEEG)](https://rave.wiki). Please check our website <https://rave.wiki>

[Here is a `sfN`
poster](https://www.dropbox.com/s/st0cw1aro4kmo2e/2022-poster-sfN-Zhengjia-RAVE_poster-07Nov22.pdf?dl=0)

## Citation

To cite `threeBrain` in publications use:

- Wang, Z., Magnotti, J. F., Zhang, X., & Beauchamp, M. S. (2023). YAEL:
  Your Advanced Electrode Localizer. Eneuro, 10(10).
- Magnotti, J. F., Wang, Z., & Beauchamp, M. S. (2020). RAVE:
  Comprehensive open-source software for reproducible analysis and
  visualization of intracranial EEG data. NeuroImage, 223, 117341.

A BibTeX entry for LaTeX users:

    @Article{,
      title = {{YAEL}: Your Advanced Electrode Localizer},
      author = {Zhengjia Wang and John F. Magnotti and Xiang Zhang and Michael S. Beauchamp},
      journal = {Eneuro},
      year = {2023},
      volume = {10},
      number = {10},
      publisher = {Society for Neuroscience},
      doi = {10.1523/ENEURO.0328-23.2023},
    }
    @Article{,
      title = {{RAVE}: Comprehensive open-source software for reproducible analysis and visualization of intracranial EEG data},
      author = {John F. Magnotti and Zhengjia Wang and Michael S. Beauchamp},
      journal = {NeuroImage},
      year = {2020},
      volume = {223},
      doi = {10.1016/j.neuroimage.2020.117341},
      pages = {117341},
    }

## License

The front-end viewer (JavaScript) is licensed under MPL-2.0 free
open-source license. Using the generated viewers or incorporating the
existing viewers as a whole into your own work “as-is” is permissive.

# Package index

## All functions

- [`AbstractGeom`](https://dipterix.org/threeBrain/reference/AbstractGeom.md)
  : R6 Class - Abstract Class of Geometries

- [`BlankGeom`](https://dipterix.org/threeBrain/reference/BlankGeom.md)
  : A geometry that renders nothing

- [`DataCubeGeom`](https://dipterix.org/threeBrain/reference/DataCubeGeom.md)
  : R6 Class - Generate Data Cube Geometry

- [`DataCubeGeom2`](https://dipterix.org/threeBrain/reference/DataCubeGeom2.md)
  : R6 Class - Generate Data Cube Geometry via 3D Volume Texture

- [`FreeGeom`](https://dipterix.org/threeBrain/reference/FreeGeom.md) :
  R6 Class - Generate Geometry from Vertices and Face Indices

- [`GeomGroup`](https://dipterix.org/threeBrain/reference/GeomGroup.md)
  : R6 Class - Generate Group of Geometries

- [`LineSegmentsGeom`](https://dipterix.org/threeBrain/reference/LineSegmentsGeom.md)
  : R6 Class - Generate Line Segments

- [`SphereGeom`](https://dipterix.org/threeBrain/reference/SphereGeom.md)
  : R6 Class - Generate Sphere Geometry

- [`SpriteGeom`](https://dipterix.org/threeBrain/reference/SpriteGeom.md)
  : R6 Class - Generate Sphere Geometry

- [`TubeGeom`](https://dipterix.org/threeBrain/reference/TubeGeom.md) :
  R6 Class - Generate Tube Geometry

- [`brain_proxy()`](https://dipterix.org/threeBrain/reference/brain_proxy.md)
  : Shiny Proxy for Viewer

- [`brain_setup()`](https://dipterix.org/threeBrain/reference/brain_setup.md)
  : Setup Package, Install Environment

- [`calculate_rotation()`](https://dipterix.org/threeBrain/reference/calculate_rotation.md)
  : Calculate rotation matrix from non-zero vectors

- [`check_freesurfer_path()`](https://dipterix.org/threeBrain/reference/check_freesurfer_path.md)
  : Function to check whether \`FreeSurfer\` folder has everything we
  need

- [`conform_volume()`](https://dipterix.org/threeBrain/reference/conform_volume.md)
  :

  Conform imaging data in `'FreeSurfer'` way

- [`create_group()`](https://dipterix.org/threeBrain/reference/create_group.md)
  : Create a geometry group containing multiple geometries

- [`cross_prod()`](https://dipterix.org/threeBrain/reference/cross_prod.md)
  : Calculate cross-product of two vectors in '3D'

- [`default_template_directory()`](https://dipterix.org/threeBrain/reference/default_template_directory.md)
  : Default Directory to Store Template Brain

- [`freesurfer_lut`](https://dipterix.org/threeBrain/reference/freesurfer_lut.md)
  : Query the 'FreeSurfer' labels

- [`generate_cortical_parcellation()`](https://dipterix.org/threeBrain/reference/generate_cortical_parcellation.md)
  : Generate cortical annotations from template using surface mapping

- [`generate_smooth_envelope()`](https://dipterix.org/threeBrain/reference/generate_smooth_envelope.md)
  : Generate smooth envelope around surface

- [`generate_subcortical_surface()`](https://dipterix.org/threeBrain/reference/generate_subcortical_surface.md)
  : Approximate 'sub-cortical' surfaces from 'parcellation'

- [`geom_freemesh()`](https://dipterix.org/threeBrain/reference/geom_freemesh.md)
  : Creates any mesh geometry given vertices and face indices

- [`geom_sphere()`](https://dipterix.org/threeBrain/reference/geom_sphere.md)
  : Create sphere geometry

- [`get_digest_header()`](https://dipterix.org/threeBrain/reference/get_digest_header.md)
  : Function to read digest header

- [`get_ijk2ras()`](https://dipterix.org/threeBrain/reference/get_ijk2ras.md)
  : Get 'voxel' to world matrix

- [`import_fs()`](https://dipterix.org/threeBrain/reference/import-fs-suma.md)
  [`import_suma()`](https://dipterix.org/threeBrain/reference/import-fs-suma.md)
  : Import 'FreeSurfer' or 'SUMA' files into the viewer structure

- [`import_from_freesurfer()`](https://dipterix.org/threeBrain/reference/import_from_freesurfer.md)
  : Import from \`FreeSurfer\` and create \`JSON\` cache for 3D viewer

- [`list_electrode_prototypes()`](https://dipterix.org/threeBrain/reference/list_electrode_prototypes.md)
  [`load_prototype()`](https://dipterix.org/threeBrain/reference/list_electrode_prototypes.md)
  : List or load all electrode prototypes

- [`localization_module()`](https://dipterix.org/threeBrain/reference/localization_module.md)
  : Launch a 'shiny' application to localize electrodes

- [`merge_brain()`](https://dipterix.org/threeBrain/reference/merge_brain.md)
  : Create Multi-subject Template

- [`new_electrode_prototype()`](https://dipterix.org/threeBrain/reference/new_electrode_prototype.md)
  : Create or load new electrode prototype from existing configurations

- [`plot_slices()`](https://dipterix.org/threeBrain/reference/plot_slices.md)
  : Plot slices of volume

- [`read_fs_asc()`](https://dipterix.org/threeBrain/reference/read_fs_asc.md)
  : Read \`FreeSurfer\` ascii file

- [`read_fs_labels()`](https://dipterix.org/threeBrain/reference/read_fs_labels.md)
  : Read FreeSurfer Annotations

- [`read_fs_m3z()`](https://dipterix.org/threeBrain/reference/read_fs_m3z.md)
  : Read \`FreeSurfer\` m3z file

- [`read_fs_mgh_mgz()`](https://dipterix.org/threeBrain/reference/read_fs_mgh_mgz.md)
  : Read \`FreeSurfer\` \`mgz/mgh\` file

- [`read_gii2()`](https://dipterix.org/threeBrain/reference/read_gii2.md)
  : Function to load surface data from \`Gifti\` files

- [`read_mgz()`](https://dipterix.org/threeBrain/reference/read_mgz.md)
  : Function to load \`FreeSurfer\` \`mgz/mgh\` file

- [`read_volume()`](https://dipterix.org/threeBrain/reference/read_volume.md)
  :

  Read volume file in `'MGH'` or `'Nifti'` formats

- [`renderBrain`](https://dipterix.org/threeBrain/reference/renderBrain.md)
  : Shiny Renderer for threeBrain Widgets

- [`reorient_volume()`](https://dipterix.org/threeBrain/reference/reorient_volume.md)
  : Function to reshape data to \`RAS\` order

- [`save_brain()`](https://dipterix.org/threeBrain/reference/save_brain.md)
  : Save threeBrain widgets to local file system

- [`seeg_prototype()`](https://dipterix.org/threeBrain/reference/seeg_prototype.md)
  :

  Create `'sEEG'` shaft geometry prototype

- [`download_template_subject()`](https://dipterix.org/threeBrain/reference/template_subject.md)
  [`download_N27()`](https://dipterix.org/threeBrain/reference/template_subject.md)
  [`set_default_template()`](https://dipterix.org/threeBrain/reference/template_subject.md)
  [`threebrain_finalize_installation()`](https://dipterix.org/threeBrain/reference/template_subject.md)
  [`available_templates()`](https://dipterix.org/threeBrain/reference/template_subject.md)
  : Download and Manage Template Subjects

- [`threeBrain()`](https://dipterix.org/threeBrain/reference/threeBrain.md)
  : Create a brain object

- [`threejsBrainOutput`](https://dipterix.org/threeBrain/reference/threejsBrainOutput.md)
  : Shiny Output for threeBrain Widgets

- [`threejs_brain()`](https://dipterix.org/threeBrain/reference/threejs_brain.md)
  : Create a Threejs Brain and View it in Browsers

- [`video_content()`](https://dipterix.org/threeBrain/reference/video_content.md)
  : Add video content to the viewer

- [`volume_to_surf()`](https://dipterix.org/threeBrain/reference/volume_to_surf.md)
  :

  Generate surface file from `'nii'` or `'mgz'` volume files

- [`create_colormap()`](https://dipterix.org/threeBrain/reference/voxel_colormap.md)
  [`save_colormap()`](https://dipterix.org/threeBrain/reference/voxel_colormap.md)
  [`freeserfer_colormap()`](https://dipterix.org/threeBrain/reference/voxel_colormap.md)
  [`load_colormap()`](https://dipterix.org/threeBrain/reference/voxel_colormap.md)
  : Color maps for volume or surface data

- [`add_voxel_cube()`](https://dipterix.org/threeBrain/reference/voxel_cube.md)
  [`add_nifti()`](https://dipterix.org/threeBrain/reference/voxel_cube.md)
  [`create_voxel_cube()`](https://dipterix.org/threeBrain/reference/voxel_cube.md)
  : Generate volume data from 'MNI' coordinates

# Articles

### All vignettes

- [Getting
  Started](https://dipterix.org/threeBrain/articles/A-getting-started.md):
- [Data Visualization
  (Electrodes)](https://dipterix.org/threeBrain/articles/B-data-visualization.md):
