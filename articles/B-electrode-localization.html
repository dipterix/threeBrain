<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Electrode Localization • threeBrain</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Electrode Localization">
<meta property="og:description" content="threeBrain">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">threeBrain</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.3.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/A-getting-started.html">Getting Started</a>
    </li>
    <li>
      <a href="../articles/B-electrode-localization.html">Electrode Localization</a>
    </li>
    <li>
      <a href="../articles/C-data-visualization.html">Data Visualization (Electrodes)</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dipterix/threeBrain/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="B-electrode-localization_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Electrode Localization</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/dipterix/threeBrain/blob/master/vignettes/B-electrode-localization.Rmd"><code>vignettes/B-electrode-localization.Rmd</code></a></small>
      <div class="hidden name"><code>B-electrode-localization.Rmd</code></div>

    </div>

    
    
<p>In <code>iEEG/ECoG</code> study, it is very common to localize the electrodes using ‘CT’ scans. The CT images have different orientations to the MR images, hence co-registration is often needed. This package does not provide co-registration functions, as different labs might have different approaches. <code>threeBrain</code> only takes co-registered CT scans and visualize them directly. Therefore if you have already co-registered CT, skip the next part.</p>
<p>The rest part of this article uses <code>N27</code> sample files mentioned by the previous vignette. If you are using this example, please execute the following R code to set up. Alternatively, you can substitute variables <code>subject_code</code> and <code>subject_path</code> accordingly.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dipterix.org/threeBrain/">threeBrain</a></span><span class="op">)</span>
<span class="va">subject_code</span> <span class="op">&lt;-</span> <span class="st">"N27"</span>
<span class="va">subject_path</span> <span class="op">&lt;-</span> <span class="st">"~/Downloads/N27"</span>
<span class="va">brain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/freesurfer_brain.html">freesurfer_brain2</a></span><span class="op">(</span><span class="va">subject_path</span>, <span class="va">subject_code</span><span class="op">)</span></code></pre></div>
<div id="ct-co-registration" class="section level2">
<h2 class="hasAnchor">
<a href="#ct-co-registration" class="anchor"></a>CT Co-registration</h2>
<p><em>(skip if you have generated co-registered CT in ‘Nifti’ formats)</em></p>
<p>This part provides one working method via <code>dcm2niix</code> and <code>FLIRT</code> packages. Again, other methods will work as long as they output CT aligned to MRI in ‘Nifti’ formats.</p>
<p>To start, please download and install <code>dcm2niix</code> (<a href="https://github.com/rordenlab/dcm2niix">link</a>), <code>FLIRT</code> packages (<a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FLIRT/StepByStep">link</a>).</p>
<p><strong>Step 1</strong>: Merge all <code>DICOM</code> images to <code>Nifti</code> format:</p>
<p>Open your terminal (<code>bash</code> or <code>power shell</code>), change directories to where <code>CT</code> <code>DICOM</code> images are, and run</p>
<pre><code>dcm2niix [folder with DICOM images]</code></pre>
<p>Do the same to <code>T1</code> MR images too.</p>
<p><strong>Step 2</strong>: Copy the two <code>.nii</code> files generated in the previous step to a same folder, rename them to be <code>ct.nii</code> and <code>t1.nii</code></p>
<pre><code>flirt -in ct.nii -ref t1.nii -out ct_in_t1.nii -omat ct2t1.mat -interp trilinear -cost mutualinfo -dof 6 -searchcost mutualinfo -searchrx -180 180 -searchry -180 180 -searchrz -180 180 </code></pre>
<p>There will be a <code>ct_in_t1.nii</code> file generated.</p>
</div>
<div id="localize-with-ct" class="section level2">
<h2 class="hasAnchor">
<a href="#localize-with-ct" class="anchor"></a>Localize with CT</h2>
<p>Assuming you have generated co-registered CT scans in file <code>ct_in_t1.nii</code>, please copy it to the subject folder. The file should be located at</p>
<ul>
<li><code>mri/ct_in_t1.nii</code></li>
</ul>
<p>Next, type in and change the file path to <code>ct_in_t1.nii</code> just created</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ct_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">subject_path</span>, <span class="st">"mri/ct_in_t1.nii"</span><span class="op">)</span>
<span class="fu">threeBrain</span><span class="fu">::</span><span class="fu"><a href="../reference/localization_module.html">localization_module</a></span><span class="op">(</span>subject_code <span class="op">=</span> <span class="va">subject_code</span>,
                                fs_path <span class="op">=</span> <span class="va">subject_path</span>,
                                ct_path <span class="op">=</span> <span class="va">ct_path</span><span class="op">)</span></code></pre></div>
<p>You will see the threshold CT displayed along with the pial surfaces.</p>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-03.png" width="100%"></p>
<p>Make sure <code>Edit Mode</code> (in the <code>Electrode Localization</code> panel) is <code>CT/Volume</code>. Now move your mouse cursor to the green electrodes, the localization control panel will display the <code>tkrRAS</code> (<code>FreeSurfer</code> coordinate), <code>T1</code> (native RAS coordinate), and <code>MNI305</code> (‘MNI’ template coordinate). <strong>Double-click</strong> on the green areas, and a new electrode will be created.</p>
<p>The default threshold of CT scans is set to 3000. However, this threshold might need to be adjusted in order to achieve high accuracy. The following figures demonstrate the results of different threshold.</p>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-04.png" width="100%"></p>
<p>If the threshold is too low, then other irrelevant structures will appear. If the threshold is too high, some electrodes might disappear.</p>
<p>To adjust the CT threshold, open the <code>Volume Settings</code> from the control panel, slide <code>Voxel Min</code>.</p>
</div>
<div id="localize-with-mri-without-ct" class="section level2">
<h2 class="hasAnchor">
<a href="#localize-with-mri-without-ct" class="anchor"></a>Localize with MRI (without CT)</h2>
<p>When electrodes are too small, or the CT is unavailable, electrode localization can be done on the MR images. Localization via MRI can be done by the following steps:</p>
<ol style="list-style-type: decimal">
<li>switch <code>Edit Mode</code> (in the <code>Electrode Localization</code> panel) to <code>MRI slices</code>
</li>
<li>open <code>Volume Settings</code> panel, enable <code>Overlay Coronal</code>, <code>Overlay Axial</code>, or <code>Overlay Sagittal</code>.</li>
<li>adjust <code>Coronal</code>, <code>Axial</code>, <code>Sagittal</code> plane to desired position</li>
<li>double-click on the MRI slices</li>
</ol>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-07.png" width="100%"></p>
</div>
<div id="automatically-interpolate-electrodes" class="section level2">
<h2 class="hasAnchor">
<a href="#automatically-interpolate-electrodes" class="anchor"></a>Automatically interpolate electrodes</h2>
<p>In most of the scenarios, electrodes form grids or strips, The <code>threeBrain</code> provides interpolation functions.</p>
<p>For example, we want to localize the electrodes circled in orange color (top-left). You could of course mark them one by one. More efficiently, you can simply localize the electrodes at both ends, set the <code>Interpolate Size</code> to 6 (there are 6 more electrodes to be added), make sure there is no other objects blocking the sight, and hit the <code>Interpolate from Recently Added</code> button (circled in the figure). All other electrodes will be automatically generated.</p>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-05.png" width="100%"></p>
<p>The newly added electrodes might be inaccurate. Don’t worry, you can adjust them later!</p>
</div>
<div id="refine-electrodes" class="section level2">
<h2 class="hasAnchor">
<a href="#refine-electrodes" class="anchor"></a>Refine electrodes</h2>
<p>Once all the electrodes are marked, change <code>Edit Mode</code> to <code>refine</code>. In the refine mode, you can</p>
<ul>
<li>Enable/Disable electrodes
<ul>
<li>To disable/enable a particular electrode, double-click one. The electrode will be highlighted in red color. Then click on <code>Enable/Disable Electrode</code>, the electrode will be disabled/enabled. The disabled electrode will be colored in gray.</li>
</ul>
</li>
<li>Adjust electrode locations
<ul>
<li>Automatically adjust all electrodes</li>
<li>Automatically adjust one electrode</li>
<li>Manually adjust one electrode</li>
</ul>
</li>
</ul>
<p>To automatically adjust all electrodes, simply click <code>Auto-Adjust All</code>. The new electrode locations will be calculated via a weighted average.</p>
<p>To automatically adjust a specific electrode, <strong>double-click</strong> one electrode. The highlighted electrode will be colored in red. Then click on <code>Auto-Adjust Highlighted</code>.</p>
<p>To manually adjust a electrode, <strong>double-click</strong> one electrode. The highlighted electrode will be colored in red. Then hover the mouse above the canvas, press and hold keyboard <code>1</code> or <code>shift+1</code> to move the electrode along <code>Right/Left</code> axis. Press and hold <code>2</code> or <code>shift+2</code> to move the electrode along <code>Anterior/Posterior</code> axis. Press and hold <code>3</code> or <code>shift+3</code> to move the electrode along <code>Superior/Inferior</code> axis.</p>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-08.png" width="100%"></p>
</div>
<div id="download-electrode-table" class="section level2">
<h2 class="hasAnchor">
<a href="#download-electrode-table" class="anchor"></a>Download Electrode Table</h2>
<p>Once Finished electrode localization, you can take screenshots by opening <code>Default</code> panel, and click on <code>Screenshot</code>.</p>
<p>To download electrode table, click on <code>Download as csv</code> in the <code>Electrode Localization</code> panel. The electrode table should look as follows:</p>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-06.png" width="100%"></p>
<p>You will notice that the <code>Electrode</code> column is left blank. This is because localization order might be different than the recording channel number. Please fill out <code>Electrode</code> column as the actual channel number (integers).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Zhengjia Wang, John Magnotti, Michael Beauchamp.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
