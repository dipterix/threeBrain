<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="threeBrain">
<title>Electrode Localization • threeBrain</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Electrode Localization">
<meta property="og:description" content="threeBrain">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">threeBrain</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.9.7</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/A-getting-started.html">Getting Started</a>
    <a class="dropdown-item" href="../articles/B-electrode-localization.html">Electrode Localization</a>
    <a class="dropdown-item" href="../articles/C-data-visualization.html">Data Visualization (Electrodes)</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/dipterix/threeBrain/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Electrode Localization</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/dipterix/threeBrain/blob/HEAD/vignettes/B-electrode-localization.Rmd" class="external-link"><code>vignettes/B-electrode-localization.Rmd</code></a></small>
      <div class="d-none name"><code>B-electrode-localization.Rmd</code></div>
    </div>

    
    
<p>In <code>iEEG/ECoG</code> study, it is very common to localize the
electrodes using ‘CT’ scans. The CT images have different orientations
to the MR images, hence co-registration is often needed. This package
does not provide co-registration functions, as different labs might have
different approaches. <code>threeBrain</code> only takes co-registered
CT scans and visualize them directly. Therefore if you have already
co-registered CT, skip the next part.</p>
<p>The rest part of this article uses <code>N27</code> sample files
mentioned by the previous vignette. If you are using this example,
please execute the following R code to set up. Alternatively, you can
substitute variables <code>subject_code</code> and
<code>subject_path</code> accordingly.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dipterix.org/threeBrain/">threeBrain</a></span><span class="op">)</span></span>
<span><span class="va">subject_code</span> <span class="op">&lt;-</span> <span class="st">"N27"</span></span>
<span><span class="va">subject_path</span> <span class="op">&lt;-</span> <span class="st">"~/Downloads/N27"</span></span>
<span><span class="va">brain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/freesurfer_brain.html">freesurfer_brain2</a></span><span class="op">(</span><span class="va">subject_path</span>, <span class="va">subject_code</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="ct-co-registration">CT Co-registration<a class="anchor" aria-label="anchor" href="#ct-co-registration"></a>
</h2>
<p><em>(skip if you have generated co-registered CT in ‘Nifti’
formats)</em></p>
<p>This part provides one working method via <code>dcm2niix</code> and
<code>FLIRT</code> packages. Again, other methods will work as long as
they output CT aligned to MRI in ‘Nifti’ formats.</p>
<p>To start, please download and install <code>dcm2niix</code> (<a href="https://github.com/rordenlab/dcm2niix" class="external-link">link</a>),
<code>FLIRT</code> packages (<a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FLIRT/StepByStep" class="external-link">link</a>).</p>
<p><strong>Step 1</strong>: Merge all <code>DICOM</code> images to
<code>Nifti</code> format:</p>
<p>Open your terminal (<code>bash</code> or <code>power shell</code>),
change directories to where <code>CT</code> <code>DICOM</code> images
are, and run</p>
<pre><code>dcm2niix [folder with DICOM images]</code></pre>
<p>Do the same to <code>T1</code> MR images too.</p>
<p><strong>Step 2</strong>: Copy the two <code>.nii</code> files
generated in the previous step to a same folder, rename them to be
<code>ct.nii</code> and <code>t1.nii</code></p>
<pre><code>flirt -in ct.nii -ref t1.nii -out ct_in_t1.nii -omat ct2t1.mat -interp trilinear -cost mutualinfo -dof 6 -searchcost mutualinfo -searchrx -180 180 -searchry -180 180 -searchrz -180 180 </code></pre>
<p>There will be a <code>ct_in_t1.nii</code> file generated.</p>
</div>
<div class="section level2">
<h2 id="localize-with-ct">Localize with CT<a class="anchor" aria-label="anchor" href="#localize-with-ct"></a>
</h2>
<p>Assuming you have generated co-registered CT scans in file
<code>ct_in_t1.nii</code>, please copy it to the subject folder. The
file should be located at</p>
<ul>
<li><code>mri/ct_in_t1.nii</code></li>
</ul>
<p>Next, type in and change the file path to <code>ct_in_t1.nii</code>
just created</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ct_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">subject_path</span>, <span class="st">"mri/ct_in_t1.nii"</span><span class="op">)</span></span>
<span><span class="fu">threeBrain</span><span class="fu">::</span><span class="fu"><a href="../reference/localization_module.html">localization_module</a></span><span class="op">(</span>subject_code <span class="op">=</span> <span class="va">subject_code</span>,</span>
<span>                                fs_path <span class="op">=</span> <span class="va">subject_path</span>,</span>
<span>                                ct_path <span class="op">=</span> <span class="va">ct_path</span><span class="op">)</span></span></code></pre></div>
<p>You will see the threshold CT displayed along with the pial
surfaces.</p>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-03.png" width="100%"></p>
<p>Make sure <code>Edit Mode</code> (in the
<code>Electrode Localization</code> panel) is <code>CT/Volume</code>.
Now move your mouse cursor to the green electrodes, the localization
control panel will display the <code>tkrRAS</code>
(<code>FreeSurfer</code> coordinate), <code>T1</code> (native RAS
coordinate), and <code>MNI305</code> (‘MNI’ template coordinate).
<strong>Double-click</strong> on the green areas, and a new electrode
will be created.</p>
<p>The default threshold of CT scans is set to 3000. However, this
threshold might need to be adjusted in order to achieve high accuracy.
The following figures demonstrate the results of different
threshold.</p>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-04.png" width="100%"></p>
<p>If the threshold is too low, then other irrelevant structures will
appear. If the threshold is too high, some electrodes might
disappear.</p>
<p>To adjust the CT threshold, open the <code>Volume Settings</code>
from the control panel, slide <code>Voxel Min</code>.</p>
</div>
<div class="section level2">
<h2 id="localize-with-mri-without-ct">Localize with MRI (without CT)<a class="anchor" aria-label="anchor" href="#localize-with-mri-without-ct"></a>
</h2>
<p>When electrodes are too small, or the CT is unavailable, electrode
localization can be done on the MR images. Localization via MRI can be
done by the following steps:</p>
<ol style="list-style-type: decimal">
<li>switch <code>Edit Mode</code> (in the
<code>Electrode Localization</code> panel) to
<code>MRI slices</code>
</li>
<li>open <code>Volume Settings</code> panel, enable
<code>Overlay Coronal</code>, <code>Overlay Axial</code>, or
<code>Overlay Sagittal</code>.</li>
<li>adjust <code>Coronal</code>, <code>Axial</code>,
<code>Sagittal</code> plane to desired position</li>
<li>double-click on the MRI slices</li>
</ol>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-07.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="automatically-interpolate-electrodes">Automatically interpolate electrodes<a class="anchor" aria-label="anchor" href="#automatically-interpolate-electrodes"></a>
</h2>
<p>In most of the scenarios, electrodes form grids or strips, The
<code>threeBrain</code> provides interpolation functions.</p>
<p>For example, we want to localize the electrodes circled in orange
color (top-left). You could of course mark them one by one. More
efficiently, you can simply localize the electrodes at both ends, set
the <code>Interpolate Size</code> to 6 (there are 6 more electrodes to
be added), make sure there is no other objects blocking the sight, and
hit the <code>Interpolate from Recently Added</code> button (circled in
the figure). All other electrodes will be automatically generated.</p>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-05.png" width="100%"></p>
<p>The newly added electrodes might be inaccurate. Don’t worry, you can
adjust them later!</p>
</div>
<div class="section level2">
<h2 id="refine-electrodes">Refine electrodes<a class="anchor" aria-label="anchor" href="#refine-electrodes"></a>
</h2>
<p>Once all the electrodes are marked, change <code>Edit Mode</code> to
<code>refine</code>. In the refine mode, you can</p>
<ul>
<li>Enable/Disable electrodes
<ul>
<li>To disable/enable a particular electrode, double-click one. The
electrode will be highlighted in red color. Then click on
<code>Enable/Disable Electrode</code>, the electrode will be
disabled/enabled. The disabled electrode will be colored in gray.</li>
</ul>
</li>
<li>Adjust electrode locations
<ul>
<li>Automatically adjust all electrodes</li>
<li>Automatically adjust one electrode</li>
<li>Manually adjust one electrode</li>
</ul>
</li>
</ul>
<p>To automatically adjust all electrodes, simply click
<code>Auto-Adjust All</code>. The new electrode locations will be
calculated via a weighted average.</p>
<p>To automatically adjust a specific electrode,
<strong>double-click</strong> one electrode. The highlighted electrode
will be colored in red. Then click on
<code>Auto-Adjust Highlighted</code>.</p>
<p>To manually adjust a electrode, <strong>double-click</strong> one
electrode. The highlighted electrode will be colored in red. Then hover
the mouse above the canvas, press and hold keyboard <code>1</code> or
<code>shift+1</code> to move the electrode along <code>Right/Left</code>
axis. Press and hold <code>2</code> or <code>shift+2</code> to move the
electrode along <code>Anterior/Posterior</code> axis. Press and hold
<code>3</code> or <code>shift+3</code> to move the electrode along
<code>Superior/Inferior</code> axis.</p>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-08.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="download-electrode-table">Download Electrode Table<a class="anchor" aria-label="anchor" href="#download-electrode-table"></a>
</h2>
<p>Once Finished electrode localization, you can take screenshots by
opening <code>Default</code> panel, and click on
<code>Screenshot</code>.</p>
<p>To download electrode table, click on <code>Download as csv</code> in
the <code>Electrode Localization</code> panel. The electrode table
should look as follows:</p>
<p><img src="https://raw.githubusercontent.com/dipterix/threeBrain-sample/master/screenshots/vignette-06.png" width="100%"></p>
<p>You will notice that the <code>Electrode</code> column is left blank.
This is because localization order might be different than the recording
channel number. Please fill out <code>Electrode</code> column as the
actual channel number (integers).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Zhengjia Wang, John Magnotti.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
